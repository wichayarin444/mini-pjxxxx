<div class="page">
  <h2>Transaction History</h2>

  <section class="search-section dx-card content-block">
    <h3>Search Criteria</h3>
    <form [formGroup]="searchForm" class="search-container">
      <div class="search-item">
        <label>Fund Code</label>
        <dx-text-box formControlName="fundCode" placeholder="Search by code"></dx-text-box>
      </div>
      <div class="search-item">
        <label>Transaction Type</label>
        <dx-select-box formControlName="type" [items]="['Buy', 'Sell']" placeholder="All" [showClearButton]="true"></dx-select-box>
      </div>
      <div class="search-item date-range">
        <label>Date Range</label>
        <div class="range-inputs">
          <dx-date-box formControlName="startDate" type="date" displayFormat="yyyy-MM-dd" placeholder="Start"></dx-date-box>
          <span class="separator">-</span>
          <dx-date-box formControlName="endDate" type="date" displayFormat="yyyy-MM-dd" placeholder="End"></dx-date-box>
        </div>
      </div>
    </form>
    <div class="actions-search">
      <dx-button text="Search" type="default" stylingMode="contained" (onClick)="onSearch()"></dx-button>
    </div>
  </section>

  <section class="list-section dx-card content-block">
    <h3>Transaction List</h3>
    <div class="list-actions">
      <dx-button text="+ New Transaction" type="default" stylingMode="contained" (onClick)="openModal()"></dx-button>
    </div>
    
    <dx-data-grid 
      [dataSource]="transactions()" 
      [showBorders]="true" 
      [columnAutoWidth]="true"
      [rowAlternationEnabled]="true">
      <dxo-paging [pageSize]="10"></dxo-paging>
      <dxo-pager [showPageSizeSelector]="true" [allowedPageSizes]="[10, 20, 50]" [showInfo]="true"></dxo-pager>

      <dxi-column dataField="fundCode" caption="Fund Code"></dxi-column>
      <dxi-column dataField="type" caption="Type" cellTemplate="typeCell"></dxi-column>
      <dxi-column dataField="amount" caption="Amount" format="#,##0.00"></dxi-column>
      <dxi-column dataField="units" caption="Units" format="#,##0.0000"></dxi-column>
      <dxi-column dataField="nav" caption="NAV" format="#,##0.0000"></dxi-column>
      <dxi-column dataField="fee" caption="Transaction Fee" format="#,##0.00"></dxi-column>
      <dxi-column dataField="net" caption="Net" format="#,##0.00"></dxi-column>
      <dxi-column dataField="timestamp" caption="Timestamp" dataType="datetime" format="yyyy-MM-dd HH:mm:ss"></dxi-column>
      <dxi-column caption="Actions" cellTemplate="actionsCell" [width]="100" alignment="center"></dxi-column>

      <div *dxTemplate="let d of 'typeCell'">
        <span [class.buy]="d.value === 'Buy'" [class.sell]="d.value === 'Sell'">{{ d.value }}</span>
      </div>

      <div *dxTemplate="let d of 'actionsCell'">
        <div class="action-buttons">
          <dx-button icon="edit" stylingMode="text" (onClick)="openModal(d.data)"></dx-button>
          <dx-button icon="trash" stylingMode="text" type="danger" (onClick)="remove(d.data.id)"></dx-button>
        </div>
      </div>
    </dx-data-grid>
  </section>

  <!-- Modal -->
  <dx-popup
    [visible]="showModal()"
    [title]="'New Transaction'"
    [showTitle]="true"
    [dragEnabled]="false"
    [hideOnOutsideClick]="true"
    [width]="700"
    [height]="'auto'"
    (onHiding)="closeModal()">
    
    <div *dxTemplate="let data of 'content'">
      <form [formGroup]="addForm" class="popup-form">
        <div class="form-row">
            <div class="field">
                <label>Fund Code</label>
                <dx-select-box formControlName="fundCode" [items]="fundList()" displayExpr="fundCode" valueExpr="fundCode" placeholder="Select Fund"></dx-select-box>
            </div>
            <div class="field">
                <label>Transaction Type</label>
                <dx-radio-group formControlName="type" [items]="['Buy', 'Sell']" layout="horizontal"></dx-radio-group>
            </div>
        </div>

        <div class="form-row" *ngIf="addForm.value.type === 'Buy'">
            <div class="field">
                <label>Amount</label>
                <dx-number-box formControlName="amount" format="#,##0.00" [min]="0"></dx-number-box>
            </div>
            <div class="field">
                <label>Units (Calculated)</label>
                <dx-number-box [value]="calculations.units" format="#,##0.0000" [readOnly]="true"></dx-number-box>
            </div>
            <div class="field">
                <label>Net (Calculated)</label>
                <dx-number-box [value]="calculations.net" format="#,##0.00" [readOnly]="true"></dx-number-box>
            </div>
        </div>

        <div class="form-row" *ngIf="addForm.value.type === 'Sell'">
            <div class="field">
                 <label>Amount (Gross)</label>
                 <dx-number-box [value]="calculations.amount" format="#,##0.00" [readOnly]="true"></dx-number-box>
            </div>
            <div class="field">
                 <label>Units</label>
                 <dx-number-box formControlName="units" format="#,##0.0000" [min]="0"></dx-number-box>
            </div>
            <div class="field">
                 <label>Net (Calculated)</label>
                 <dx-number-box [value]="calculations.net" format="#,##0.00" [readOnly]="true"></dx-number-box>
            </div>
        </div>

        <div class="form-row">
            <div class="field">
                <label>Current NAV</label>
                <dx-number-box [value]="calculations.nav" format="#,##0.0000" [readOnly]="true"></dx-number-box>
            </div>
            <div class="field">
                <label>Transaction Fee</label>
                <dx-number-box [value]="calculations.fee" format="#,##0.00" [readOnly]="true"></dx-number-box>
            </div>
        </div>

        <div class="popup-footer">
          <dx-button text="Cancel" stylingMode="outlined" (onClick)="closeModal()"></dx-button>
          <dx-button text="Save Transaction" type="success" stylingMode="contained" (onClick)="save()" 
            [disabled]="addForm.invalid || (addForm.value.type === 'Buy' && calculations.amount <= 0) || (addForm.value.type === 'Sell' && calculations.units <= 0)">
          </dx-button>
        </div>
      </form>
    </div>
  </dx-popup>
</div>
